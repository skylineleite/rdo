'<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link rel="manifest" href="manifest.json">
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }
</script>

  <meta charset="UTF-8">
  <title>Relat√≥rio Di√°rio de Obras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
  
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background-color: #fff;
    color: #000;
  }

  h1 {
    font-size: 24px;
    margin-bottom: 20px;
  }

  h2 {
    background: #eee;
    padding: 10px;
    border-left: 5px solid #333;
    font-size: 18px;
    margin-top: 40px;
  }

  .form-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
  }

  .form-table th,
  .form-table td {
    border: 1px solid #ccc;
    padding: 10px;
    vertical-align: top;
  }

  label {
    font-weight: bold;
    display: block;
    margin-bottom: 5px;
  }

  input[type="text"],
  input[type="number"],
  input[type="date"],
  input[type="time"],
  select {
    width: 100%;
    padding: 8px;
    box-sizing: border-box;
    margin-bottom: 10px;
  }

  input[type="file"] {
    margin-top: 5px;
  }

  /* Alinhamento horizontal entre input e texto */
  .inline-option {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    width: 100%;
    flex-wrap: wrap;
  }

  .inline-option input[type="checkbox"],
  .inline-option input[type="radio"] {
    flex-shrink: 0;
  }

  .inline-option label {
    margin: 0;
    font-weight: normal;
  }

  /* Estilo para grupos de op√ß√µes */
  .checkbox-group,
  .radio-group {
    margin-top: 10px;
  }

  .checkbox-group .inline-option,
  .radio-group .inline-option {
    margin-bottom: 8px;
  }

  /* Responsividade b√°sica */
  @media (max-width: 600px) {
    h1 {
      font-size: 20px;
    }

    h2 {
      font-size: 16px;
    }

    input,
    select {
      font-size: 14px;
    }
  }
  .tempo-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

.tempo-table th,
.tempo-table td {
  border: 1px solid #ccc;
  padding: 10px;
  text-align: center;
}

.tempo-table th {
  background-color: #f0f0f0;
  font-weight: bold;
}

</style>
</head>
<body>
  <script>
    fetch("RDO_MODELO.xlsx")
      .then(res => res.arrayBuffer())
      .then(data => {
        workbookModelo = XLSX.read(data, { type: "array" });
        console.log("Modelo carregado com sucesso!");
      });

    function gerarRDO() {
      if (!workbookModelo) {
        alert("Modelo ainda n√£o carregado.");
        return;
      }
      const sigla = document.getElementById("sigla").value.trim();
      const data = document.getElementById("data").value;

      // Converte data de "2025-10-30" para "30-10-2025"
      const dataFormatada = data.split("-").reverse().join("-");

      // Monta o nome do arquivo
      const nomeArquivo = `${sigla}_${dataFormatada}.xlsx`;

      const sheet = workbookModelo.Sheets["RDO"];
      sheet["E6"] = { t: "s", v: "30/10/2025" };
       // ‚úÖ 2. Produ√ß√£o (Se√ß√£o 04)
  
       const atividades = [];
      document.querySelectorAll("#atividades-container .atividade-bloco, .atividade-extra").forEach((bloco, i) => {
      const pistaSelecionada = Array.from(bloco.querySelectorAll(`input[name^="pista_"]:checked`))
      .map(cb => cb.value)
      .join(", ");

    atividades.push({
      Atividade: `${i + 1}`,
      Servico: bloco.querySelector(`select[name^="servico_"]`)?.value || "",
      Outro: bloco.querySelector(`input[name^="servico_outro_"]`)?.value || "",
      KM_Inicial: bloco.querySelector(`input[name^="km_inicial_"]`)?.value || "",
      KM_Final: bloco.querySelector(`input[name^="km_final_"]`)?.value || "",
      Pista: pistaSelecionada,
      Ordem_Servico: bloco.querySelector(`input[name^="ordem_servico_"]`)?.value || "",
      Hora_Inicio: bloco.querySelector(`input[name^="hora_inicio_"]`)?.value || "",
      Hora_Fim: bloco.querySelector(`input[name^="hora_fim_"]`)?.value || ""
    });
  });

  XLSX.utils.book_append_sheet(workbookModelo, XLSX.utils.json_to_sheet(atividades), "Produ√ß√£o");

  // üíæ Salvar arquivo
  const wbout = XLSX.write(workbookModelo, { bookType: "xlsx", type: "binary" });

  function s2ab(s) {
    const buf = new ArrayBuffer(s.length);
    const view = new Uint8Array(buf);
    for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i);
    return buf;
  }

  saveAs(new Blob([s2ab(wbout)], { type: "application/octet-stream" }), nomeArquivo);
}

      const wbout = XLSX.write(workbookModelo, { bookType: "xlsx", type: "binary" });

      function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i);
        return buf;
      }

      saveAs(new Blob([s2ab(wbout)], { type: "application/octet-stream" }), nomeArquivo);
    

// 3. Equipamentos
const equipamentos = [];

// Captura os checkboxes marcados
document.querySelectorAll('input[name="equipamento"]:checked').forEach(cb => {
  equipamentos.push({ Equipamento: cb.value, Quantidade: 1 });
});

// Captura os selects de quantidade
[
  "qtd_rocadeira", "qtd_soprador", "qtd_motopoda", "qtd_motosserra",
  "qtd_betoneira", "qtd_gerador", "qtd_furadeira"
].forEach(name => {
  const el = document.querySelector(`select[name="${name}"]`);
  if (el) {
    equipamentos.push({ Equipamento: name.replace("qtd_", "").toUpperCase(), Quantidade: el.value });
  }
});

// Captura o campo "Outro"
const outroEquip = document.querySelector('input[name="equipamento_outro"]')?.value;
if (outroEquip) {
  equipamentos.push({ Equipamento: "OUTRO", Descri√ß√£o: outroEquip });
}

XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(equipamentos), "Equipamentos");

  // 4. M√£o de Obra
const mod = [];

[
  "encarregado", "motorista", "ajudante", "rocadeira", "trator",
  "retro", "bate_estaca", "oficial", "supervisor"
].forEach(funcao => {
  const el = document.querySelector(`select[name="hist_${funcao}"]`);
  if (el) {
  mod.push({ Funcao: funcao.toUpperCase(), Quantidade: el.value });
  }
});

const outroMod = document.querySelector('input[name="hist_outro"]')?.value;
if (outroMod) {
  mod.push({ Funcao: "OUTRO", Descri√ß√£o: outroMod });
}

XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mod), "M√£o de Obra");

  // 5. Fotos
  const fotos = [];
  document.querySelectorAll('input[type="file"]').forEach((input, i) => {
    Array.from(input.files).forEach(file => {
      fotos.push({ Atividade: `Atividade ${i + 1}`, Foto: file.name });
    });
  });
XLSX.utils.book_append_sheet(workbookModelo, XLSX.utils.json_to_sheet(fotos), "Fotos");
XLSX.writeFile(workbookModelo, "RDO.xlsx");

</script>

<!-- Parte de gera√ß√£o do RDO -->

<script>
  function abrirDialogGerar() {
    document.getElementById("dialog-gerar").style.display = "block";
  }

  function abrirDialogLimpar() {
    document.getElementById("dialog-limpar").style.display = "block";
  }

  function fecharDialog(id) {
    document.getElementById(id).style.display = "none";
  }

 function executarGeracao() {
  fecharDialog("dialog-gerar");

  // Gera o arquivo Excel com os dados do formul√°rio
  gerarRDO();

  alert("RDO gerado.");

  // Limpa todos os campos
  document.querySelectorAll("input, select").forEach(el => {
    if (el.type === "checkbox" || el.type === "radio") {
      el.checked = false;
    } else if (el.type === "file") {
      el.value = null;
    } else {
      el.value = "";
    }
  });

  // Volta para o topo da p√°gina
  window.scrollTo({ top: 0, behavior: "smooth" });
}


  function executarLimpeza() {
    fecharDialog("dialog-limpar");
    document.querySelectorAll("input, select").forEach(el => {
      if (el.type === "checkbox" || el.type === "radio") {
        el.checked = false;
      } else if (el.type === "file") {
        el.value = null;
      } else {
        el.value = "";
      }
    });
    alert("Formul√°rio limpo.");
  }
</script>

<!-- Script para adicionar/remover atividades -->
 
<script>
  let atividadeCount = 1;
  const maxAtividades = 5;

  function confirmarNovaAtividade() {
    if (atividadeCount >= maxAtividades) {
      alert("Limite de 5 atividades atingido.");
      return;
    }
    document.getElementById("dialog-atividade").style.display = "block";
  }

  function adicionarAtividade() {
    fecharDialog("dialog-atividade");
    atividadeCount++;

    const nova = document.createElement("div");
    nova.className = "atividade-extra";
    nova.style.opacity = 0;
    nova.innerHTML = `
      <h2>Se√ß√£o 04 ‚Äì ${atividadeCount}¬™ Atividade</h2>
      <button onclick="removerAtividade(this)">üóëÔ∏è</button>

      <label>Servi√ßo Executado:</label>
      <select name="servico_${atividadeCount}">
        <option value="">Escolher</option>
        <option>RO√áADA MANUAL</option>
        <option>LAVAGEM DE DEFENSA</option>
        <option>LIMPEZA</option>
        <option>LIMPEZA DE INSTALA√á√ÉO OPERACIONAL</option>
        <option>CATA-CATA</option>
        <option>INSTALA√á√ÉO DE DEFENSA</option>
        <option>REPARO DE DEFENSA</option>
        <option>RECOLHIMENTO DE ENTULHO</option>
        <option>OBRA CIVIL</option>
        <option>INSTALA√á√ÉO DE CATADI√ìPTRICO</option>
        <option>REPOSI√á√ÉO DE CATADI√ìPTRICO</option>
        <option>RECOMPOSI√á√ÉO DE TALUDE</option>
      </select>
      <br><label>Outro:</label>
      <input type="text" name="servico_outro_${atividadeCount}">

      <div style="display: flex; gap: 20px;">
        <div style="flex: 1;">
          <label>KM Inicial:</label>
          <input type="number" name="km_inicial_${atividadeCount}">
        </div>
        <div style="flex: 1;">
          <label>KM Final:</label>
          <input type="number" name="km_final_${atividadeCount}">
        </div>
      </div>

      <label>Pista - Local:</label>
      <div class="inline-option"><input type="checkbox" name="pista_${atividadeCount}" value="NORTE"> NORTE</div>
      <div class="inline-option"><input type="checkbox" name="pista_${atividadeCount}" value="SUL"> SUL</div>
      <div class="inline-option"><input type="checkbox" name="pista_${atividadeCount}" value="CANTEIRO CENTRAL"> CANTEIRO CENTRAL</div>
      <div class="inline-option"><input type="checkbox" name="pista_${atividadeCount}" value="MARGINAL"> MARGINAL</div>
      <div class="inline-option"><input type="checkbox" name="pista_${atividadeCount}" value="TREVO / VIADUTO / AL√áA"> TREVO / VIADUTO / AL√áA</div>
      <label>Outro:</label>
      <input type="text" name="pista_outro_${atividadeCount}">

      <label>Ordem de Servi√ßo:</label>
      <input type="text" name="ordem_servico_${atividadeCount}">

      <label>Hor√°rio de In√≠cio:</label>
      <input type="time" name="hora_inicio_${atividadeCount}">
      <label>Hor√°rio de T√©rmino:</label>
      <input type="time" name="hora_fim_${atividadeCount}">

      <label>Anexar Fotos (m√≠nimo 6, m√°ximo 10):</label>
      <input type="file" name="fotos_${atividadeCount}" accept="image/*" multiple>
    `;

    document.getElementById("atividades-container").appendChild(nova);

    setTimeout(() => {
      nova.style.transition = "opacity 0.5s";
      nova.style.opacity = 1;
      nova.scrollIntoView({ behavior: "smooth" });
    }, 50);
  }

  function removerAtividade(btn) {
    if (confirm("Remover esta atividade?")) {
      btn.parentElement.remove();
      atividadeCount--;
    }
  }

  function fecharDialog(id) {
    document.getElementById(id).style.display = "none";
  }
</script>


<!-- SE√á√ÉO 1 ‚Äì CABE√áALHO -->

<h1>Relat√≥rio Di√°rio de Obras</h1>

<h2>Se√ß√£o 1 ‚Äì Cabe√ßalho</h2>
<table class="form-table">
  <tr>
    <td>
      <label>Data:</label>
      <input type="date" id="data" name="data" value="">
    </td>
    <td>
      <label>Sigla da Equipe:</label>
      <select id="sigla" name="sigla">
        <option value="">Escolher</option>
        <option>RM01</option><option>RM02</option><option>RM03</option><option>RM04</option>
        <option>RM05</option><option>RM06</option><option>RM07</option><option>DR01</option>
        <option>CL01</option><option>CL02</option><option>CV01</option><option>CV02</option>
        <option>EPS01</option><option>EPS02</option><option>LP01</option><option>OTB</option>
        <option>TP01</option><option>TP02</option><option>OUTRA</option>
      </select>
    </td>
  </tr>
  <tr>
    <td colspan="2">
      <label>Encarregado:</label>
      <input type="text" id="encarregado" name="encarregado">
    </td>
  </tr>
</table>

<h2>Condi√ß√µes do Tempo</h2>
<table class="tempo-table">
  <tr>
    <th></th>
    <th>Manh√£</th>
    <th>Tarde</th>
    <th>Noite</th>
    <th>Chuva mm:</th>
  </tr>
  <tr>
    <td><strong>Bom</strong></td>
    <td><input type="checkbox" id="tempo_bom_manha" name="tempo_bom_manha"></td>
    <td><input type="checkbox" id="tempo_bom_tarde" name="tempo_bom_tarde"></td>
    <td><input type="checkbox" id="tempo_bom_noite" name="tempo_bom_noite"></td>
    <td rowspan="2"><input type="text" id="chuva_mm" name="chuva_mm" value="0mm"></td>
  </tr>
  <tr>
    <td><strong>Chuva</strong></td>
    <td><input type="checkbox" id="tempo_chuva_manha" name="tempo_chuva_manha"></td>
    <td><input type="checkbox" id="tempo_chuva_tarde" name="tempo_chuva_tarde"></td>
    <td><input type="checkbox" id="tempo_chuva_noite" name="tempo_chuva_noite"></td>
  </tr>
</table>

<h2>Ocorr√™ncias</h2>
<div style="display: flex; gap: 20px; flex-wrap: wrap;">
  <div style="flex: 1; min-width: 200px;">
    <label>Acidentes com perda de tempo:</label>
    <div class="inline-option"><input type="radio" id="acidente_sim" name="acidente" value="Sim"> Sim</div>
    <div class="inline-option"><input type="radio" id="acidente_nao" name="acidente" value="N√£o"> N√£o</div>
  </div>
  <div style="flex: 1; min-width: 200px;">
    <label>Quase Acidentes:</label>
    <div class="inline-option"><input type="radio" id="quase_sim" name="quase" value="Sim"> Sim</div>
    <div class="inline-option"><input type="radio" id="quase_nao" name="quase" value="N√£o"> N√£o</div>
  </div>
</div>


<!-- SE√á√ÉO 2 ‚Äì EQUIPAMENTOS E VE√çCULOS -->

<h2>Se√ß√£o 2 ‚Äì Equipamentos e Ve√≠culos</h2>

<label>Ve√≠culos / M√°quinas Pesadas:</label>
<div style="margin-bottom: 20px;">
  <div class="inline-option"><input type="checkbox" id="equipamento1" name="equipamento" value="CAMINH√ÉO 3/4 COM CABINE AUXILIAR"> CAMINH√ÉO 3/4 COM CABINE AUXILIAR</div>
  <div class="inline-option"><input type="checkbox" id="equipamento2" name="equipamento" value="CAMINH√ÉO COMPACTADOR"> CAMINH√ÉO COMPACTADOR</div>
  <div class="inline-option"><input type="checkbox" id="equipamento3" name="equipamento" value="CAMINH√ÉO MUNCK"> CAMINH√ÉO MUNCK</div>
  <div class="inline-option"><input type="checkbox" id="equipamento4" name="equipamento" value="CAMINH√ÉO MUNCK BATE ESTACA"> CAMINH√ÉO MUNCK BATE ESTACA</div>
  <div class="inline-option"><input type="checkbox" id="equipamento5" name="equipamento" value="CAMINH√ÉO ROLLON ROLLOFF"> CAMINH√ÉO ROLLON ROLLOFF</div>
  <div class="inline-option"><input type="checkbox" id="equipamento6" name="equipamento" value="CAMINH√ÉO TOCO BASCULANTE"> CAMINH√ÉO TOCO BASCULANTE</div>
  <div class="inline-option"><input type="checkbox" id="equipamento7" name="equipamento" value="VE√çCULO UTILIT√ÅRIO"> VE√çCULO UTILIT√ÅRIO</div>
  <div class="inline-option"><input type="checkbox" id="equipamento8" name="equipamento" value="RETROESCAVADEIRA"> RETROESCAVADEIRA</div>
  <div class="inline-option"><input type="checkbox" id="equipamento9" name="equipamento" value="MINICARREGADEIRA"> MINICARREGADEIRA</div>
  <div class="inline-option"><input type="checkbox" id="equipamento10" name="equipamento" value="TRATOR IMPLEMENTO DE RO√áADA"> TRATOR IMPLEMENTO DE RO√áADA</div>
</div>

<table class="form-table">
  <tr>
    <td>
      <label>Ro√ßadeira:</label>
      <select id="qtd_rocadeira" name="qtd_rocadeira">
<option value="0">0</option>

        <option>0</option><option>1</option><option>2</option><option>3</option>
        <option>4</option><option>5</option><option>6</option><option>7</option>
        <option>8</option><option>9</option><option>10</option>
      </select>
    </td>
    <td>
      <label>Soprador:</label>
      <select id="qtd_soprador" name="qtd_soprador">
        <option value="0">0</option>
        <option>0</option><option>1</option><option>2</option><option>3</option>
        <option>4</option><option>5</option><option>6</option><option>7</option>
        <option>8</option><option>9</option><option>10</option>
      </select>
    </td>
  </tr>

  <tr>
    <td>
      <label>Motopoda:</label>
      <select id="qtd_motopoda" name="qtd_motopoda">
        <option value="0">0</option>
        <option>0</option><option>1</option><option>2</option><option>3</option>
      </select>
    </td>
    <td>
      <label>Motosserra:</label>
      <select id="qtd_motosserra" name="qtd_motosserra">
        <option value="0">0</option>
        <option>0</option><option>1</option><option>2</option><option>3</option>
      </select>
    </td>
  </tr>

  <tr>
    <td>
      <label>Betoneira:</label>
      <select id="qtd_betoneira" name="qtd_betoneira">
        <option value="0">0</option>
        <option>0</option><option>1</option><option>2</option><option>3</option>
      </select>
    </td>
    <td>
      <label>Gerador:</label>
      <select id="qtd_gerador" name="qtd_gerador">
        <option value="0">0</option>
        <option>0</option><option>1</option><option>2</option><option>3</option>
      </select>
    </td>
  </tr>

  <tr>
    <td>
      <label>Furadeira:</label>
      <select id="qtd_furadeira" name="qtd_furadeira">
        <option value="0">0</option>
        <option>0</option><option>1</option><option>2</option><option>3</option>
      </select>
    </td>
    <td>
      <label>Outro:</label>
      <input type="text" id="equipamento_outro" name="equipamento_outro">
    </td>
  </tr>
</table>

<!-- SE√á√ÉO 3 ‚Äì HISTOGRAMA -->

<h2>Se√ß√£o 3 ‚Äì Histograma</h2>
<table class="form-table">
  <tr>
    <td>
      <label>Encarregado:</label>
      <select id="hist_encarregado" name="hist_encarregado">
        <option value="0">0</option>
        <option value="0">0</option><option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option><option value="5">5</option>
        <option value="6">6</option><option value="7">7</option><option value="8">8</option>
        <option value="9">9</option><option value="10">10</option>
      </select>
    </td>
    <td>
      <label>Motorista:</label>
      <select id="hist_motorista" name="hist_motorista">
        <option value="0">0</option>
        <option value="0">0</option><option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option><option value="5">5</option>
        <option value="6">6</option><option value="7">7</option><option value="8">8</option>
        <option value="9">9</option><option value="10">10</option>
      </select>
    </td>
  </tr>
  <tr>
    <td>
      <label>Ajudante:</label>
      <select id="hist_ajudante" name="hist_ajudante">
        <option value="0">0</option>
        <option value="0">0</option><option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option><option value="5">5</option>
        <option value="6">6</option><option value="7">7</option><option value="8">8</option>
        <option value="9">9</option><option value="10">10</option>
      </select>
    </td>
    <td>
      <label>Operador de Ro√ßadeira:</label>
      <select id="hist_rocadeira" name="hist_rocadeira">
        <option value="0">0</option>
        <option value="0">0</option><option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option><option value="5">5</option>
        <option value="6">6</option><option value="7">7</option><option value="8">8</option>
        <option value="9">9</option><option value="10">10</option>
      </select>
    </td>
  </tr>
  <tr>
    <td>
      <label>Operador de Trator:</label>
      <select id="hist_trator" name="hist_trator">
        <option value="0">0</option>
        <option value="0">0</option><option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option><option value="5">5</option>
        <option value="6">6</option><option value="7">7</option><option value="8">8</option>
        <option value="9">9</option><option value="10">10</option>
      </select>
    </td>
    <td>
      <label>Operador de Retro:</label>
      <select id="hist_retro" name="hist_retro">
        <option value="0">0</option>
        <option value="0">0</option><option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option><option value="5">5</option>
        <option value="6">6</option><option value="7">7</option><option value="8">8</option>
        <option value="9">9</option><option value="10">10</option>
      </select>
    </td>
  </tr>
  <tr>
    <td>
      <label>Operador de Bate Estaca:</label>
      <select id="hist_bate_estaca" name="hist_bate_estaca">
        <option value="0">0</option>
        <option value="0">0</option><option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option><option value="5">5</option>
        <option value="6">6</option><option value="7">7</option><option value="8">8</option>
        <option value="9">9</option><option value="10">10</option>
      </select>
    </td>
    <td>
      <label>Oficial:</label>
      <select id="hist_oficial" name="hist_oficial">
        <option value="0">0</option>
        <option value="0">0</option><option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option><option value="5">5</option>
        <option value="6">6</option><option value="7">7</option><option value="8">8</option>
        <option value="9">9</option><option value="10">10</option>
      </select>
    </td>
  </tr>
  <tr>
    <td>
      <label>Supervisor:</label>
      <select id="hist_supervisor" name="hist_supervisor">
        <option value="0">0</option>
        <option value="0">0</option><option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option><option value="5">5</option>
        <option value="6">6</option><option value="7">7</option><option value="8">8</option>
        <option value="9">9</option><option value="10">10</option>
      </select>
    </td>
    <td>
      <label>Outro:</label>
      <input type="text" id="hist_outro" name="hist_outro">
    </td>
  </tr>
</table>


<!-- SE√á√ÉO 4 ‚Äì PRODU√á√ÉO -->

<h2>Se√ß√£o 4 ‚Äì Produ√ß√£o</h2>
<div id="atividades-container">
  <div class="atividade-bloco">
    <label>Servi√ßo Executado:</label>
    <select id="servico_1" name="servico_1">
      <option value="">Escolher</option>
      <option>RO√áADA MANUAL</option>
      <option>LAVAGEM DE DEFENSA</option>
      <option>LIMPEZA</option>
      <option>LIMPEZA DE INSTALA√á√ÉO OPERACIONAL</option>
      <option>CATA-CATA</option>
      <option>INSTALA√á√ÉO DE DEFENSA</option>
      <option>REPARO DE DEFENSA</option>
      <option>RECOLHIMENTO DE ENTULHO</option>
      <option>OBRA CIVIL</option>
      <option>INSTALA√á√ÉO DE CATADI√ìPTRICO</option>
      <option>REPOSI√á√ÉO DE CATADI√ìPTRICO</option>
      <option>RECOMPOSI√á√ÉO DE TALUDE</option>
    </select>
    <br><label>Outro:</label>
    <input type="text" id="servico_outro_1" name="servico_outro_1">

    <div style="display: flex; gap: 20px;">
      <div style="flex: 1;">
        <label>KM Inicial:</label>
        <input type="number" id="km_inicial_1" name="km_inicial_1">
      </div>
      <div style="flex: 1;">
        <label>KM Final:</label>
        <input type="number" id="km_final_1" name="km_final_1">
      </div>
    </div>

    <label>Pista - Local:</label>
    <div class="inline-option"><input type="checkbox" id="pista_1" name="pista_1" value="NORTE"> NORTE</div>
    <div class="inline-option"><input type="checkbox" id="pista_1" name="pista_1" value="SUL"> SUL</div>
    <div class="inline-option"><input type="checkbox" id="pista_1" name="pista_1" value="CANTEIRO CENTRAL"> CANTEIRO CENTRAL</div>
    <div class="inline-option"><input type="checkbox" id="pista_1" name="pista_1" value="MARGINAL"> MARGINAL</div>
    <div class="inline-option"><input type="checkbox" id="pista_1" name="pista_1" value="TREVO / VIADUTO / AL√áA"> TREVO / VIADUTO / AL√áA</div>
    <label>Outro:</label>
    <input type="text" id="pista_outro_1" name="pista_outro_1">

    <label>Ordem de Servi√ßo:</label>
    <input type="text" id="ordem_servico_1" name="ordem_servico_1">

    <label>Hor√°rio de In√≠cio:</label>
    <input type="time" id="hora_inicio_1" name="hora_inicio_1">
    <label>Hor√°rio de T√©rmino:</label>
    <input type="time" id="hora_fim_1" name="hora_fim_1">

    <label>Anexar Fotos (m√≠nimo 6, m√°ximo 10):</label>
    <input type="file" id="fotos_1" name="fotos_1" accept="image/*" multiple>
  </div>
</div>

<div style="text-align: center; margin-top: 20px;">
  <button onclick="confirmarNovaAtividade()" style="padding: 10px 20px;">‚ûï Adicionar outra atividade</button>
</div>

<!-- Caixa de confirma√ß√£o -->
<div id="dialog-atividade" class="dialog-box">
  <p><strong>Deseja adicionar uma nova atividade?</strong></p>
  <button onclick="adicionarAtividade()">Sim</button>
  <button onclick="fecharDialog('dialog-atividade')">N√£o</button>
</div>

<!-- Estilo adicional -->
<style>
  .atividade-extra {
    margin-top: 30px;
    padding: 15px;
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    position: relative;
  }

  .atividade-extra h2 {
    margin-top: 0;
  }

  .atividade-extra button {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
  }

  .dialog-box {
    display: none;
    position: fixed;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -30%);
    background: #fff;
    border: 2px solid #333;
    padding: 20px;
    z-index: 9999;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    text-align: center;
  }

  .dialog-box button {
    margin: 10px;
    padding: 8px 16px;
    font-weight: bold;
  }
</style>

<h2>Finalizar Relat√≥rio</h2>
<table class="form-table">
  <tr>
    <td style="text-align: center;">
      <button onclick="abrirDialogGerar()" style="padding: 10px 20px; font-weight: bold;">GERAR RDO</button>
    </td>
    <td style="text-align: center;">
      <button onclick="abrirDialogLimpar()" style="padding: 10px 20px; font-weight: bold;">LIMPAR</button>
    </td>
  </tr>
</table>

<!-- Caixa de di√°logo GERAR -->
<div id="dialog-gerar" class="dialog-box">
  <p><strong>Tem certeza que deseja gerar o RDO?</strong></p>
  <button onclick="executarGeracao()">Gerar</button>
  <button onclick="fecharDialog('dialog-gerar')">Conferir RDO antes</button>
</div>

<!-- Caixa de di√°logo LIMPAR -->
<div id="dialog-limpar" class="dialog-box">
  <p><strong>Tem certeza que deseja limpar o formul√°rio?</strong></p>
  <button onclick="executarLimpeza()">Sim</button>
  <button onclick="fecharDialog('dialog-limpar')">N√£o</button>
</div>
<script>
  // Removido c√≥digo duplicado e tag <script> extra
  // Se precisar de upload manual, use o seguinte exemplo:
  /*
  document.getElementById("modeloXLSX").addEventListener("change", function (e) {
    const reader = new FileReader();
    reader.onload = function (event) {
      const data = event.target.result;
      workbookModelo = XLSX.read(data, { type: "binary" });
      alert("Modelo carregado com sucesso!");
    };
    reader.readAsBinaryString(e.target.files[0]);
  });
  */
  // Fun√ß√£o auxiliar para salvar o arquivo
  function s2ab(s) {
    const buf = new ArrayBuffer(s.length);
    const view = new Uint8Array(buf);
    for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i);
    return buf;
  }
</script>


<script>
  let workbookModelo;

  // üîΩ Carrega automaticamente o modelo ao abrir o app
  fetch("RDO_MODELO.xlsx")
  .then(res => {
    if (!res.ok) throw new Error("Falha ao buscar o arquivo modelo");
    return res.arrayBuffer();
  })
  .then(data => {
    workbookModelo = XLSX.read(data, { type: "array" });
    console.log("Modelo XLSX carregado com sucesso!");
  })
  .catch(err => {
    console.error("Erro ao carregar o modelo:", err);
    alert("N√£o foi poss√≠vel carregar o modelo RDO_MODELO.XLSX.");
  });

  // üîΩ Fun√ß√£o para gerar o RDO preenchido
  function gerarRDO() {
    if (!workbookModelo) {
      alert("O modelo ainda n√£o foi carregado.");
      return;
    }

    const sheet = workbookModelo.Sheets["RDO"]; // nome da aba

    // üìÖ Dados Gerais
    const data = document.getElementById("data").value;
    const dataFormatada = data.split("-").reverse().join("/"); // DD/MM/AAAA
    sheet["E6"] = { t: "s", v: dataFormatada };
    sheet["AD9"] = { t: "s", v: document.getElementById("chuva_mm").value };
    const acidenteSelecionado = document.querySelector('input[name="acidente"]:checked');
    sheet["AR7"] = { t: "s", v: acidenteSelecionado ? acidenteSelecionado.value : "" };
    const quaseSelecionado = document.querySelector('input[name="quase"]:checked');
    sheet["AR9"] = { t: "s", v: quaseSelecionado ? quaseSelecionado.value : "" };

    // üå§Ô∏è Condi√ß√µes Clim√°ticas
    sheet["R8"] = { t: "s", v: document.getElementById("tempo_bom_manha").checked ? "X" : "" };
    sheet["R9"] = { t: "s", v: document.getElementById("tempo_chuva_manha").checked ? "X" : "" };
    sheet["V8"] = { t: "s", v: document.getElementById("tempo_bom_tarde").checked ? "X" : "" };
    sheet["V9"] = { t: "s", v: document.getElementById("tempo_chuva_tarde").checked ? "X" : "" };
    sheet["Z8"] = { t: "s", v: document.getElementById("tempo_chuva_tarde").checked ? "X" : "" };
    sheet["Z9"] = { t: "s", v: document.getElementById("tempo_chuva_noite").checked ? "X" : "" };

    // üöõ Equipamentos
    for (let i = 1; i <= 10; i++) {
    const id = `equipamento${i}`;
    const checkbox = document.getElementById(id);
    const valor = checkbox && checkbox.checked ? 1 : ""; // ‚Üê trocado 0 por ""
    sheet[`O${13 + i}`] = { t: "n", v: valor }; // O14 at√© O23
    }
    const qtdRocadeira = document.getElementById("qtd_rocadeira").value;
    sheet["O24"] = { t: "s", v: qtdRocadeira === "0" ? "" : qtdRocadeira };
    const qtd_soprador = document.getElementById("qtd_soprador").value;
    sheet["O25"] = { t: "s", v: qtd_soprador === "0" ? "" : qtd_soprador }; 
    const qtd_motopoda = document.getElementById("qtd_motopoda").value;
    sheet["O26"] = { t: "s", v: qtd_motopoda === "0" ? "" : qtd_motopoda };
    const qtd_motosserra = document.getElementById("qtd_motosserra").value;
    sheet["O27"] = { t: "s", v: qtd_motosserra === "0" ? "" : qtd_motosserra }; 
    const qtd_betoneira = document.getElementById("qtd_betoneira").value;
    sheet["O28"] = { t: "s", v: qtd_betoneira === "0" ? "" : qtd_betoneira }; 
    const qtd_gerador = document.getElementById("qtd_gerador").value;
    sheet["O29"] = { t: "s", v: qtd_gerador === "0" ? "" : qtd_gerador };
    const qtd_furadeira = document.getElementById("qtd_furadeira").value;
    sheet["O30"] = { t: "s", v: qtd_furadeira === "0" ? "" : qtd_furadeira };   
 
    // üë∑ M√£o de Obra
    sheet["AD14"] = { t: "s", v: parseInt(document.getElementById("hist_encarregado").value) || "" };
    sheet["AD15"] = { t: "s", v: parseInt(document.getElementById("hist_motorista").value) || "" };
    sheet["AD16"] = { t: "s", v: parseInt(document.getElementById("hist_ajudante").value) || "" };
    sheet["AD17"] = { t: "s", v: parseInt(document.getElementById("hist_rocadeira").value) || "" };    
    sheet["AD"] = { t: "s", v: parseInt(document.getElementById("hist_trator").value) || "" };
    sheet["AD"] = { t: "s", v: parseInt(document.getElementById("hist_retro").value) || "" };
    sheet["AD"] = { t: "s", v: parseInt(document.getElementById("hist_bate_estaca").value) || "" };
    sheet["AD"] = { t: "s", v: parseInt(document.getElementById("hist_oficial").value) || "" };
    sheet["AD"] = { t: "s", v: parseInt(document.getElementById("hist_supervisor").value) || "" };

    // üõ†Ô∏è Atividade Executada
    const sigla = document.getElementById("sigla").value.trim();
    sheet["F35"] = { t: "s", v: sigla };
    sheet["F36"] = { t: "s", v: document.getElementById("servico_1").value };
    const kmInicial = document.getElementById("km_inicial_1").value;
    const kmFinal = document.getElementById("km_final_1").value;
    const faixaKM = `Km ${kmInicial} a ${kmFinal}`;
    sheet["F37"] = { t: "s", v: faixaKM };
    sheet["F38"] = { t: "s", v: document.getElementById("pista_1").value };

    const ordemServico = document.getElementById("ordem_servico_1").value || "";
    const textoordemServico = ordemServico ? `Ordem de servi√ßo: ${ordemServico}` : "";
    sheet["F40"] = { t: "s", v: textoordemServico };

    const horaInicio = document.getElementById("hora_inicio_1").value || "";
    const textoHoraInicio = horaInicio ? `Hor√°rio de In√≠cio: ${horaInicio}` : "";
    sheet["F41"] = { t: "s", v: textoHoraInicio };

    const horaFim = document.getElementById("hora_fim_1").value || "";
    const textoHoraFim = horaFim ? `Hor√°rio de T√©rmino: ${horaFim}` : "";
    sheet["F42"] = { t: "s", v: textoHoraFim };
    sheet["D57"] = { t: "s", v: document.getElementById("encarregado").value };

    // üìÅ Nome do arquivo
    const nomeArquivo = `${sigla}_${data.split("-").reverse().join("-")}.xlsx`;

    // üíæ Finaliza e salva
    const wbout = XLSX.write(workbookModelo, { bookType: "xlsx", type: "binary" });

    function s2ab(s) {
      const buf = new ArrayBuffer(s.length);
      const view = new Uint8Array(buf);
      for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i);
      return buf;
    }

    saveAs(new Blob([s2ab(wbout)], { type: "application/octet-stream" }), nomeArquivo);
  }

</script>